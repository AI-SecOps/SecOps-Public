{  
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",  
  "contentVersion": "1.0.0.0",  
  "parameters": {  
    "functionAppName": {  
      "type": "string",  
      "defaultValue": "ai-assistant"  
    },  
    "location": {  
      "type": "string",  
      "defaultValue": "East US"  
    },  
    "NewStorageAccountName": {  
      "type": "string",  
      "defaultValue": "aifunctionstor"  
    },  
    "userAssignedIdentityName": {  
      "type": "string",  
      "defaultValue": "AzOpenAI_MI"  
    },  
    "openAiEndpoint": {  
      "type": "string",  
      "defaultValue": "https://mith-azopenai.openai.azure.com/"  
    },  
    "openAiDeployment": {  
      "type": "string",  
      "defaultValue": "gpt-4.1"  
    },  
    "openAiApiVersion": {  
      "type": "string",  
      "defaultValue": "2024-02-15-preview"  
    }  
  },  
  "variables": {  
    "userAssignedIdentityId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]",  
    "serverFarm_externalId": "[resourceId('Microsoft.Web/serverfarms', concat(parameters('functionAppName'), '-asp'))]",  
    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('NewStorageAccountName'))]"  
  },  
  "resources": [  
    {  
      "type": "Microsoft.Storage/storageAccounts",  
      "apiVersion": "2022-05-01",  
      "name": "[parameters('NewStorageAccountName')]",  
      "location": "[parameters('location')]",  
      "sku": {  
        "name": "Standard_LRS"  
      },  
      "kind": "StorageV2",  
      "properties": {  
        "accessTier": "Hot",  
        "supportsHttpsTrafficOnly": true,  
        "minimumTlsVersion": "TLS1_2",  
        "allowBlobPublicAccess": false,  
        "publicNetworkAccess": "Enabled"  
      }  
    },  
    {  
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",  
      "apiVersion": "2023-01-31",  
      "name": "[parameters('userAssignedIdentityName')]",  
      "location": "[parameters('location')]"  
    },  
    {  
      "type": "Microsoft.Web/serverfarms",  
      "apiVersion": "2022-03-01",  
      "name": "[concat(parameters('functionAppName'), '-asp')]",  
      "location": "[parameters('location')]",  
      "kind": "linux",  
      "sku": {  
        "Tier": "Dynamic",  
        "Name": "Y1"  
      },  
      "properties": {  
        "reserved": true  
      }  
    },  
    {  
      "type": "Microsoft.Web/sites",  
      "apiVersion": "2022-03-01",  
      "name": "[parameters('functionAppName')]",  
      "location": "[parameters('location')]",  
      "kind": "functionapp,linux",  
      "identity": {  
        "type": "UserAssigned",  
        "userAssignedIdentities": {  
          "[variables('userAssignedIdentityId')]": {}  
        }  
      },  
      "dependsOn": [  
        "[variables('serverFarm_externalId')]",  
        "[variables('storageAccountId')]",  
        "[variables('userAssignedIdentityId')]"  
      ],  
      "properties": {  
        "serverFarmId": "[variables('serverFarm_externalId')]",  
        "siteConfig": {  
          "linuxFxVersion": "Python|3.12",  
          "appSettings": [  
            {  
              "name": "AzureWebJobsStorage",  
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('NewStorageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('NewStorageAccountName')), '2022-05-01').keys[0].value)]"  
            },  
            {  
              "name": "FUNCTIONS_WORKER_RUNTIME",  
              "value": "python"  
            },  
            {  
              "name": "WEBSITE_RUN_FROM_PACKAGE",  
              "value": "1"  
            },  
            {  
              "name": "OPENAI_ENDPOINT",  
              "value": "[parameters('openAiEndpoint')]"  
            },  
            {  
              "name": "OPENAI_DEPLOYMENT",  
              "value": "[parameters('openAiDeployment')]"  
            },  
            {  
              "name": "OPENAI_API_VERSION",  
              "value": "[parameters('openAiApiVersion')]"  
            },  
            {  
              "name": "AzureWebJobsStorage__credential",  
              "value": "managedidentity"  
            },  
            {  
              "name": "AzureWebJobsStorage__blobServiceUri",  
              "value": "[concat('https://', parameters('NewStorageAccountName'), '.blob.core.windows.net')]"  
            },  
            {  
              "name": "AzureWebJobsStorage__queueServiceUri",  
              "value": "[concat('https://', parameters('NewStorageAccountName'), '.queue.core.windows.net')]"  
            },  
            {  
              "name": "AzureWebJobsStorage__tableServiceUri",  
              "value": "[concat('https://', parameters('NewStorageAccountName'), '.table.core.windows.net')]"  
            }  
            // Add more app settings as needed  
          ]  
        },  
        "httpsOnly": true  
      }  
    }  
  ]  
}  
